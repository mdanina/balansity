# üîÑ Retry Logic —Å Exponential Backoff

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ (retry) —Å exponential backoff –¥–ª—è –≤—Å–µ—Ö –æ—á–µ—Ä–µ–¥–µ–π –≤ queue worker. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ü–∏–∫–ª—ã –ø—Ä–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤.

## üéØ –ü—Ä–æ–±–ª–µ–º–∞, –∫–æ—Ç–æ—Ä—É—é —Ä–µ—à–∞–µ—Ç

**–î–æ:** –ü—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–¥–∞—á–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞—Å—å –≤ –æ—á–µ—Ä–µ–¥—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫:
- –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º —Ü–∏–∫–ª–∞–º –ø—Ä–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, SMTP –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
- –ü–µ—Ä–µ–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫

**–ü–æ—Å–ª–µ:** 
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)
- Exponential backoff - –∫–∞–∂–¥–∞—è —Å–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å –±–æ–ª—å—à–µ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ø—ã—Ç–∫–∞—Ö —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∑–∞–¥–∞—á–µ

## ‚öôÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ `read_ct` –∏–∑ pgmq –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–ø—ã—Ç–æ–∫:

- `read_ct = 0` - –ø–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞
- `read_ct = 1` - –≤—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞
- `read_ct = 2` - —Ç—Ä–µ—Ç—å—è –ø–æ–ø—ã—Ç–∫–∞
- –∏ —Ç.–¥.

**–¢–µ–∫—É—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ = read_ct + 1**

–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è pgmq –ø—Ä–∏ –∫–∞–∂–¥–æ–º —á—Ç–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.

### 2. Exponential Backoff

–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ (–¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–æ pgmq –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ –ø–æ—Ä—è–¥–∫—É):

- –ü–æ–ø—ã—Ç–∫–∞ 1 (read_ct=0): 1 —Å–µ–∫—É–Ω–¥–∞
- –ü–æ–ø—ã—Ç–∫–∞ 2 (read_ct=1): 2 —Å–µ–∫—É–Ω–¥—ã
- –ü–æ–ø—ã—Ç–∫–∞ 3 (read_ct=2): 4 —Å–µ–∫—É–Ω–¥—ã
- –ü–æ–ø—ã—Ç–∫–∞ 4 (read_ct=3): 8 —Å–µ–∫—É–Ω–¥
- –ü–æ–ø—ã—Ç–∫–∞ 5 (read_ct=4): 16 —Å–µ–∫—É–Ω–¥
- –ú–∞–∫—Å–∏–º—É–º: 60 —Å–µ–∫—É–Ω–¥

–¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–π jitter (0-30%) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è "thundering herd" –ø—Ä–æ–±–ª–µ–º—ã.

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** pgmq –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É, –ø–æ—ç—Ç–æ–º—É —Ä–µ–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏.

### 3. –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

```typescript
const task = await readFromQueue('queue_name', 5);
const queueTask: QueueTask = {
  msg_id: task.msg_id,
  read_ct: task.read_ct, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ pgmq
  // ...
};

try {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á–∏
  await processTask();
  await archiveTask(); // –£—Å–ø–µ—Ö - –∞—Ä—Ö–∏–≤–∏—Ä—É–µ–º
} catch (error) {
  const attemptCount = getCurrentAttemptCount(queueTask); // read_ct + 1
  
  if (shouldRetry(queueTask, config)) {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –æ—á–µ—Ä–µ–¥—å - pgmq –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–ª–∏—á–∏—Ç read_ct –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —á—Ç–µ–Ω–∏–∏
    await returnTaskToQueue(queueName, msgId);
    logger.warn(`Task will retry (attempt ${attemptCount + 1}/${maxAttempts})`);
  } else {
    // –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç - –∞—Ä—Ö–∏–≤–∏—Ä—É–µ–º –∫–∞–∫ –Ω–µ—É–¥–∞—á–Ω—É—é
    await archiveTask();
    logger.error(`Task failed after ${attemptCount} attempts`);
  }
}
```

## üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

| –û—á–µ—Ä–µ–¥—å | –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ |
|---------|------------------|-----------|
| Email | 5 | `MAX_EMAIL_RETRY_ATTEMPTS` |
| Payments | 5 | `MAX_PAYMENT_RETRY_ATTEMPTS` |
| Reports | 3 | `MAX_REPORT_RETRY_ATTEMPTS` |

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env` —Ñ–∞–π–ª queue worker:

```env
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Retry
MAX_EMAIL_RETRY_ATTEMPTS=5
MAX_PAYMENT_RETRY_ATTEMPTS=5
MAX_REPORT_RETRY_ATTEMPTS=3
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (5 –¥–ª—è email/payments, 3 –¥–ª—è reports).

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

```typescript
// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ read_ct –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ = 0
await queueEmailTask(
  'user@example.com',
  'Subject',
  'template',
  {}
);
// –ü—Ä–∏ –ø–µ—Ä–≤–æ–º —á—Ç–µ–Ω–∏–∏ read_ct = 0, attempt = 1
// –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –æ—á–µ—Ä–µ–¥—å –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º —á—Ç–µ–Ω–∏–∏ read_ct = 1, attempt = 2
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–≥–∞—Ö

```
[INFO] Processing email task (attempt 3/5): user@example.com - Subject
[WARN] Failed to send email, will retry (attempt 3/5)
[ERROR] Email failed after 5 attempts. Task archived.
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤** - –∑–∞–¥–∞—á–∏ –Ω–µ –±—É–¥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –≤–µ—á–Ω–æ
2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏** - exponential backoff —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–∏—Å—Ç–µ–º—É
3. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** - –≤–∏–¥–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –∏ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–∏
4. **–ì–∏–±–∫–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏–º–∏—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–¥–∞—á
5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ** - –Ω–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–µ –∑–∞—Å–æ—Ä—è—é—Ç –æ—á–µ—Ä–µ–¥—å

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞—á —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏

```sql
-- –ù–∞–π—Ç–∏ –∑–∞–¥–∞—á–∏ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ø—ã—Ç–æ–∫
-- read_ct –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∑–∞–¥–∞—á–∞ –±—ã–ª–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–∞
SELECT 
  msg_id,
  read_ct as attempts,
  enqueued_at as first_attempt,
  vt as visibility_timeout
FROM pgmq.email_queue
WHERE read_ct > 3;
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–æ–º–µ—Ä–∞ –ø–æ–ø—ã—Ç–∫–∏:

```
[INFO] Processing email task (attempt 1/5): user@example.com
[WARN] Email task will retry (attempt 2/5)
[ERROR] Email task failed after 5 attempts. Task archived.
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **read_ct —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è pgmq –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** - —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —á—Ç–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
2. **–¢–µ–∫—É—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ = read_ct + 1** - —Ç–∞–∫ –∫–∞–∫ read_ct –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0
3. **–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ—Å–ª–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –∑–∞–¥–∞—á–∞ –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è (–º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å)
4. **–†–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã** - email –∏ payments –±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã (5 –ø–æ–ø—ã—Ç–æ–∫), reports –º–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã (3 –ø–æ–ø—ã—Ç–∫–∏)
5. **pgmq.nack –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ** - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –Ω–æ read_ct –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —á—Ç–µ–Ω–∏–∏

---

**–°–∏—Å—Ç–µ–º–∞ retry –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ü–∏–∫–ª—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤!** ‚úÖ

