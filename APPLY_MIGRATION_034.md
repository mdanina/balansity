# üîí –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 034: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## üìã –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è

–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —É—è–∑–≤–∏–º–æ—Å—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ **"Function Search Path Mutable"** –¥–ª—è –≤—Å–µ—Ö 20 —Ñ—É–Ω–∫—Ü–∏–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

–î–æ–±–∞–≤–ª—è–µ—Ç `SET search_path = ''` –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º, —á—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç SQL injection —á–µ—Ä–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–µ search_path.

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

–≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** –∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ!

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Supabase Dashboard (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Supabase: `https://oyuyienekon.beget.app`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
3. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `supabase/migrations/034_fix_function_search_path_security.sql`
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å SQL –∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞
5. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor
6. –ù–∞–∂–º–∏—Ç–µ **Run** –∏–ª–∏ **Execute**

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ Supabase CLI

```bash
# –ï—Å–ª–∏ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Supabase CLI
supabase db push
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ psql –Ω–∞–ø—Ä—è–º—É—é

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
psql -h –≤–∞—à-—Ö–æ—Å—Ç -U –≤–∞—à-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -d –≤–∞—à-–±–∞–∑–∞

# –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
\i supabase/migrations/034_fix_function_search_path_security.sql
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ SQL

–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –≤ SQL Editor:

```sql
SELECT 
  p.proname as function_name,
  CASE 
    WHEN pg_get_functiondef(p.oid) LIKE '%SET search_path%' THEN '‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ'
    ELSE '‚ùå –¢—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è'
  END as status
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public'
  AND p.proname IN (
    'update_updated_at_column',
    'handle_new_user',
    'calculate_checkup_scores',
    'calculate_parent_scores',
    'calculate_family_scores',
    'complete_assessment',
    'get_active_assessment',
    'is_admin',
    'is_staff',
    'queue_email_task',
    'queue_report_generation',
    'queue_payment_processing',
    'send_appointment_reminders',
    'update_appointment_statuses',
    'handle_completed_checkup',
    'handle_new_appointment',
    'handle_payment_status_change',
    'pgmq_read',
    'pgmq_archive',
    'pgmq_nack'
  )
ORDER BY p.proname;
```

–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ".

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Security Advisor

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Security Advisor** –≤ Supabase Dashboard
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **Warnings**
3. –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è "Function Search Path Mutable" –¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å
4. –ù–∞–∂–º–∏—Ç–µ **Rerun linter** –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞

## üîç –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

–ú–∏–≥—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:

1. ‚úÖ `update_updated_at_column` - —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è updated_at
2. ‚úÖ `handle_new_user` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
3. ‚úÖ `calculate_checkup_scores` - —Ä–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤ –¥–ª—è —á–µ–∫–∞–ø–∞
4. ‚úÖ `calculate_parent_scores` - —Ä–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤ –¥–ª—è parent –æ—Ü–µ–Ω–∫–∏
5. ‚úÖ `calculate_family_scores` - —Ä–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤ –¥–ª—è family –æ—Ü–µ–Ω–∫–∏
6. ‚úÖ `complete_assessment` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏
7. ‚úÖ `get_active_assessment` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
8. ‚úÖ `is_admin` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
9. ‚úÖ `is_staff` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
10. ‚úÖ `queue_email_task` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å email
11. ‚úÖ `queue_report_generation` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
12. ‚úÖ `queue_payment_processing` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
13. ‚úÖ `send_appointment_reminders` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è—Ö
14. ‚úÖ `update_appointment_statuses` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
15. ‚úÖ `handle_completed_checkup` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–≥–æ —á–µ–∫–∞–ø–∞
16. ‚úÖ `handle_new_appointment` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
17. ‚úÖ `handle_payment_status_change` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
18. ‚úÖ `pgmq_read` - —á—Ç–µ–Ω–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
19. ‚úÖ `pgmq_archive` - –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
20. ‚úÖ `pgmq_nack` - –≤–æ–∑–≤—Ä–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥—å

## üõ°Ô∏è –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ

–ë–µ–∑ `SET search_path = ''` –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç:

1. –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É —Å –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏
2. –ò–∑–º–µ–Ω–∏—Ç—å search_path –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –≤–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
3. –ó–∞—Å—Ç–∞–≤–∏—Ç—å –≤–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–¥ –≤–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ

–° `SET search_path = ''` —Ñ—É–Ω–∫—Ü–∏—è –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–Ω—ã–µ –∏–º–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `public.users` –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ `users`), —á—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ç–∞–∫—É—é –∞—Ç–∞–∫—É.

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ú–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–∞ –∏ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É —Ñ—É–Ω–∫—Ü–∏–π
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- –ò–∑–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ `search_path`
- –ú–∏–≥—Ä–∞—Ü–∏—é –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –±–µ–∑ –≤—Ä–µ–¥–∞

## üö® –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ —á—Ç–æ-—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞–ª–æ —Ä–∞–±–æ—Ç–∞—Ç—å:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –æ—à–∏–±–æ–∫ –≤ Supabase Dashboard
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã (—Å–º. –ø—Ä–æ–≤–µ—Ä–∫—É –≤—ã—à–µ)
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (pgmq, pg_cron) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

---

**–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å–µ 20 –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –≤ Security Advisor –¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å!** ‚úÖ

