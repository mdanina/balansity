# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ÆKassa –¥–ª—è –ø—Ä–∏–µ–º–∞ –æ–ø–ª–∞—Ç—ã –∑–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –ÆKassa –¥–ª—è –ø—Ä–∏–µ–º–∞ –æ–ø–ª–∞—Ç—ã –∑–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –ø–∞–∫–µ—Ç—ã —Å–µ—Å—Å–∏–π. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π `queue-worker`, –∫–æ—Ç–æ—Ä—ã–π —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è –∫–∞–∫ API —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, —Ç–∞–∫ –∏ worker –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

1. **API —Å–µ—Ä–≤–µ—Ä (Express)** - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å—ã:
   - –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–µ–π
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç –ÆKassa

2. **Worker –ø—Ä–æ—Ü–µ—Å—Å** - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥–∏:
   - –§–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

3. **Frontend** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
   - –í–∏–¥–∂–µ—Ç –ÆKassa –¥–ª—è –æ–ø–ª–∞—Ç—ã
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API —Å–µ—Ä–≤–µ—Ä–æ–º

### –ü–æ—Ç–æ–∫ –æ–ø–ª–∞—Ç—ã

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Frontend ‚Üí API Server ‚Üí –ÆKassa API
                ‚Üì
            –í–∏–¥–∂–µ—Ç –ÆKassa
                ‚Üì
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
                ‚Üì
            –ÆKassa ‚Üí Webhook ‚Üí API Server ‚Üí –ë–î
                ‚Üì
            Frontend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### Backend (queue-worker)

```
queue-worker/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts              # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª (API + Worker)
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts          # Express –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ payments.ts   # –†–æ—É—Ç—ã –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ webhook.ts    # –†–æ—É—Ç –¥–ª—è webhook
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ yookassa.ts       # –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ÆKassa API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supabase.ts       # (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ email.ts         # (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
‚îÇ   ‚îî‚îÄ‚îÄ processors/
‚îÇ       ‚îî‚îÄ‚îÄ payments.ts       # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏
‚îú‚îÄ‚îÄ package.json              # (–æ–±–Ω–æ–≤–ª–µ–Ω: –¥–æ–±–∞–≤–ª–µ–Ω—ã express, cors)
‚îî‚îÄ‚îÄ .env                      # (–¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ÆKassa)
```

### Frontend

```
src/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ payment.ts            # –û–±–Ω–æ–≤–ª–µ–Ω: –≤—ã–∑–æ–≤—ã API –≤–º–µ—Å—Ç–æ –∑–∞–≥–ª—É—à–µ–∫
‚îî‚îÄ‚îÄ pages/
    ‚îî‚îÄ‚îÄ Payment.tsx           # –û–±–Ω–æ–≤–ª–µ–Ω: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞ –ÆKassa
```

## üß™ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–í–∞–∂–Ω–æ:** –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è webhook –ª–æ–∫–∞–ª—å–Ω–æ –Ω—É–∂–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π URL. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Ç—É–Ω–Ω–µ–ª–∏.

üìñ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** [LOCAL_TESTING_WEBHOOK.md](./LOCAL_TESTING_WEBHOOK.md)

**–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç —Å ngrok:**
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ API —Å–µ—Ä–≤–µ—Ä
cd queue-worker
npm run dev

# 2. –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ ngrok
ngrok http 3001

# 3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://abc123.ngrok.io)
# 4. –î–æ–±–∞–≤—å—Ç–µ –≤ –ÆKassa webhook: https://abc123.ngrok.io/api/webhook/yookassa
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. Backend (queue-worker)

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd queue-worker
npm install
```

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `queue-worker/.env` (–∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π):

```env
# Supabase
SUPABASE_URL=https://oyuyienekon.beget.app
SUPABASE_SERVICE_ROLE_KEY=–≤–∞—à-service-role-key

# API Server
API_PORT=3001
API_BASE_URL=https://–≤–∞—à-–¥–æ–º–µ–Ω.com
FRONTEND_URL=https://–≤–∞—à-–¥–æ–º–µ–Ω.com

# YooKassa
YUKASSA_SHOP_ID=–≤–∞—à-shop-id
YUKASSA_SECRET_KEY=–≤–∞—à-secret-key

# Worker –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
WORKER_INTERVAL_MS=5000
MAX_TASKS_PER_CYCLE=10
LOG_LEVEL=info
```

**–í–∞–∂–Ω–æ:**
- `API_BASE_URL` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (–¥–ª—è webhook –æ—Ç –ÆKassa)
- `FRONTEND_URL` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è CORS –Ω–∞—Å—Ç—Ä–æ–µ–∫
- `YUKASSA_SHOP_ID` –∏ `YUKASSA_SECRET_KEY` - –ø–æ–ª—É—á–∞—é—Ç—Å—è –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa

#### –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π –ÆKassa

**–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (—Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏ —É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω—ã):**
```env
YUKASSA_SHOP_ID=1219382
YUKASSA_SECRET_KEY=test_UNRmTdMtTWuCm362Zkzn0xWhP8CVu_cvxKQ_jxjVXUg
```

**–î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞:**
1. –ó–∞–π–¥–∏—Ç–µ –≤ [–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa](https://yookassa.ru/)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–ö–ª—é—á–∏ API"
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ:
   - **Shop ID** ‚Üí `YUKASSA_SHOP_ID`
   - **–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á** ‚Üí `YUKASSA_SECRET_KEY`

### 2. Frontend

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª `.env.local` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
VITE_SUPABASE_URL=https://oyuyienekon.beget.app
VITE_SUPABASE_ANON_KEY=–≤–∞—à-anon-key

# API URL –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
# –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
VITE_API_URL=http://localhost:3001
# –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (—á–µ—Ä–µ–∑ nginx):
# VITE_API_URL=https://–≤–∞—à-–¥–æ–º–µ–Ω.com/api
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ reverse proxy –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è API –∑–∞–ø—Ä–æ—Å–æ–≤:

```nginx
server {
    listen 80;
    server_name –≤–∞—à-–¥–æ–º–µ–Ω.com;

    # Frontend
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # API –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
    location /api {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –≤ –ÆKassa

1. –ó–∞–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
3. –î–æ–±–∞–≤—å—Ç–µ URL –¥–ª—è webhook:
   ```
   https://–≤–∞—à-–¥–æ–º–µ–Ω.com/api/webhook/yookassa
   ```
4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è:
   - ‚úÖ `payment.succeeded`
   - ‚úÖ `payment.canceled`

## üöÄ –ó–∞–ø—É—Å–∫

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

#### Backend

```bash
cd queue-worker
npm run dev
```

–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç—É 3001 (–∏–ª–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–º –≤ `API_PORT`).

#### Frontend

```bash
npm run dev
```

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω

#### Backend (PM2)

```bash
cd queue-worker
npm run build
npm run start:pm2
```

#### Backend (Docker)

```bash
cd queue-worker
docker-compose up -d
```

## üì° API Endpoints

### POST /api/payments/create

–°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ –≤ –ÆKassa.

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "amount": 5000,
  "currency": "RUB",
  "metadata": {
    "type": "appointment",
    "appointment_id": "uuid",
    "appointment_type_id": "uuid"
  }
}
```

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
```
Authorization: Bearer <supabase_jwt_token>
Content-Type: application/json
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "payment_id": "uuid",
  "confirmation_token": "confirmation_token_from_yookassa"
}
```

### POST /api/payments/verify

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –≤ –ÆKassa.

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "payment_id": "uuid"
}
```

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
```
Authorization: Bearer <supabase_jwt_token>
Content-Type: application/json
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "completed",
  "payment": {
    "id": "uuid",
    "status": "completed",
    "amount": 5000,
    ...
  }
}
```

### POST /api/webhook/yookassa

Webhook –æ—Ç –ÆKassa (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏).

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "event": "payment.succeeded",
  "object": {
    "id": "yookassa_payment_id",
    "status": "succeeded",
    "metadata": {
      "payment_id": "uuid"
    }
  }
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "received": true
}
```

### GET /health

Health check endpoint.

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "ok",
  "service": "balansity-api"
}
```

## üíª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞ Frontend

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

```typescript
import { useCreatePayment } from '@/hooks/usePayments';

const createPayment = useCreatePayment();

const handlePayment = async () => {
  const result = await createPayment.mutateAsync({
    amount: 5000,
    currency: 'RUB',
    paymentMethod: 'yookassa',
    metadata: {
      type: 'appointment',
      appointment_id: appointmentId,
      appointment_type_id: appointmentTypeId,
    },
  });

  // result.paymentUrl —Å–æ–¥–µ—Ä–∂–∏—Ç confirmation_token
  // –í–∏–¥–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ Payment.tsx
};
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞

```typescript
import { verifyPaymentWithAPI } from '@/lib/payment';

const status = await verifyPaymentWithAPI(paymentId);
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ API

1. **JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - –≤—Å–µ endpoints –∫—Ä–æ–º–µ webhook —Ç—Ä–µ–±—É—é—Ç –≤–∞–ª–∏–¥–Ω—ã–π Supabase JWT —Ç–æ–∫–µ–Ω
2. **CORS** - –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–æ–ª—å–∫–æ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ `FRONTEND_URL`
3. **–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏** - —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è, –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –∫–æ–¥

### Webhook –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

Webhook endpoint –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –Ω–æ:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `payment_id` –≤ metadata
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏
- –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã

–î–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É IP –∞–¥—Ä–µ—Å–æ–≤ –ÆKassa.

## üêõ Troubleshooting

### API —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
   ```bash
   cd queue-worker
   cat .env | grep -E "API_PORT|SUPABASE"
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –ø–æ—Ä—Ç:
   ```bash
   lsof -i :3001
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   ```bash
   tail -f queue-worker/logs/out.log
   ```

### –í–∏–¥–∂–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –≤–∏–¥–∂–µ—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è:
   ```javascript
   console.log(window.YooMoneyCheckoutWidget);
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `confirmation_token` –ø–æ–ª—É—á–µ–Ω:
   ```javascript
   console.log(confirmationToken);
   ```

### Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `API_BASE_URL` –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ API —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü–ª–∞—Ç–µ–∂ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ worker:
   ```bash
   tail -f queue-worker/logs/out.log
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ API:
   ```bash
   curl -X POST http://localhost:3001/api/payments/verify \
     -H "Authorization: Bearer <token>" \
     -H "Content-Type: application/json" \
     -d '{"payment_id": "uuid"}'
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `queue-worker/logs/`:
- `out.log` - –æ–±—â–∏–π –≤—ã–≤–æ–¥
- `error.log` - –æ—à–∏–±–∫–∏

### –ú–µ—Ç—Ä–∏–∫–∏

–ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π

–°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ç—Ä–µ–º—è —Å–ø–æ—Å–æ–±–∞–º–∏:

1. **Webhook –æ—Ç –ÆKassa** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
2. **–†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** - —á–µ—Ä–µ–∑ `POST /api/payments/verify`
3. **Worker –ø—Ä–æ—Ü–µ—Å—Å** - —Ñ–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Idempotency Key** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `payment.id` –∫–∞–∫ `Idempotence-Key` –¥–ª—è –ÆKassa, —á—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π

2. **–°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏** - –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è:
   - `appointments.payment_id` - –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
   - `package_purchases` - –¥–ª—è –ø–∞–∫–µ—Ç–æ–≤ (–ª–æ–≥–∏–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ)

3. **–ß–µ–∫–∏ 54-–§–ó** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
   - `tax_system_code: 3` (–£–°–ù –¥–æ—Ö–æ–¥—ã-—Ä–∞—Å—Ö–æ–¥—ã)
   - `vat_code: 6` (–ù–î–° –Ω–µ –æ–±–ª–∞–≥–∞–µ—Ç—Å—è)

4. **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã** - –≤—Å–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ UTC, –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ÆKassa API](https://yookassa.ru/developers/api)
- [–í–∏–¥–∂–µ—Ç –ÆKassa](https://yookassa.ru/developers/payment-forms/widget)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Supabase](https://supabase.com/docs)

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ `queue-worker/logs/`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ

