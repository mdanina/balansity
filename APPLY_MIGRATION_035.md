# ‚ö° –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 035: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ RLS

## üìã –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è

–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ **"Auth RLS Initialization Plan"** –¥–ª—è –≤—Å–µ—Ö RLS –ø–æ–ª–∏—Ç–∏–∫.

**–ü—Ä–æ–±–ª–µ–º–∞:** `auth.uid()` –ø–µ—Ä–µ–æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ, —á—Ç–æ –∑–∞–º–µ–¥–ª—è–µ—Ç —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–∞—Ö –¥–∞–Ω–Ω—ã—Ö.

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–∞ `auth.uid()` –Ω–∞ `(select auth.uid())` - –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Supabase Dashboard (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Supabase: `https://oyuyienekon.beget.app`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
3. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `supabase/migrations/035_fix_rls_auth_uid_performance.sql`
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å SQL –∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞
5. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor
6. –ù–∞–∂–º–∏—Ç–µ **Run** –∏–ª–∏ **Execute**

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ Supabase CLI

```bash
# –ï—Å–ª–∏ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Supabase CLI
supabase db push
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ psql –Ω–∞–ø—Ä—è–º—É—é

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
psql -h –≤–∞—à-—Ö–æ—Å—Ç -U –≤–∞—à-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -d –≤–∞—à-–±–∞–∑–∞

# –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
\i supabase/migrations/035_fix_rls_auth_uid_performance.sql
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Security Advisor

1. –û—Ç–∫—Ä–æ–π—Ç–µ **Security Advisor** –≤ Supabase Dashboard
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **Warnings**
3. –í—Å–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è "Auth RLS Initialization Plan" –¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å
4. –ù–∞–∂–º–∏—Ç–µ **Rerun linter** –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ SQL

–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫ —Å auth.uid() (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
SELECT 
  schemaname,
  tablename,
  policyname,
  qual,
  with_check
FROM pg_policies
WHERE schemaname = 'public'
  AND (
    qual::text LIKE '%auth.uid()%' 
    OR with_check::text LIKE '%auth.uid()%'
  )
  AND (
    qual::text NOT LIKE '%(select auth.uid())%'
    AND with_check::text NOT LIKE '%(select auth.uid())%'
  );
```

–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã! ‚úÖ

## üîç –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

–ú–∏–≥—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü:

1. ‚úÖ **users** - 4 –ø–æ–ª–∏—Ç–∏–∫–∏ (view, update, insert + –∞–¥–º–∏–Ω—Å–∫–∞—è)
2. ‚úÖ **profiles** - 7 –ø–æ–ª–∏—Ç–∏–∫ (view, insert, update, delete + 3 –∞–¥–º–∏–Ω—Å–∫–∏–µ)
3. ‚úÖ **assessments** - 6 –ø–æ–ª–∏—Ç–∏–∫ (view, insert, update, delete + 2 –∞–¥–º–∏–Ω—Å–∫–∏–µ)
4. ‚úÖ **answers** - 5 –ø–æ–ª–∏—Ç–∏–∫ (view, insert, update, delete + –∞–¥–º–∏–Ω—Å–∫–∞—è)
5. ‚úÖ **appointments** - 6 –ø–æ–ª–∏—Ç–∏–∫ (view, insert, update, delete + 2 –∞–¥–º–∏–Ω—Å–∫–∏–µ)
6. ‚úÖ **payments** - 4 –ø–æ–ª–∏—Ç–∏–∫–∏ (view, insert, update + 2 –∞–¥–º–∏–Ω—Å–∫–∏–µ)
7. ‚úÖ **package_purchases** - 4 –ø–æ–ª–∏—Ç–∏–∫–∏ (view, insert, update + 2 –∞–¥–º–∏–Ω—Å–∫–∏–µ)

**–í—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:** ~36 –ø–æ–ª–∏—Ç–∏–∫

## üìà –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:

- **–ó–∞–ø—Ä–æ—Å—ã —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç—Ä–æ–∫** –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –±—ã—Å—Ç—Ä–µ–µ
- **auth.uid()** –±—É–¥–µ—Ç –≤—ã—á–∏—Å–ª—è—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –≤–º–µ—Å—Ç–æ N —Ä–∞–∑ (–≥–¥–µ N = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫)
- **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö** —Å–Ω–∏–∑–∏—Ç—Å—è –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

**–ü—Ä–∏–º–µ—Ä —É–ª—É—á—à–µ–Ω–∏—è:**
- –î–æ: –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ 1000 —Å—Ç—Ä–æ–∫, `auth.uid()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 1000 —Ä–∞–∑
- –ü–æ—Å–ª–µ: –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ 1000 —Å—Ç—Ä–æ–∫, `auth.uid()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 1 —Ä–∞–∑

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –õ–æ–≥–∏–∫–∞ –ø–æ–ª–∏—Ç–∏–∫ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è
- ‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–µ–º–∏ –∂–µ
- ‚úÖ –ò–∑–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–± –≤—ã—á–∏—Å–ª–µ–Ω–∏—è `auth.uid()`
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–µ —Å–Ω–∏–∂–∞–µ—Ç—Å—è

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ú–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–∞ –∏ –º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ
- –í—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—é—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–æ–º
- –°—Ç–∞—Ä—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö (DROP POLICY IF EXISTS)
- –ú–∏–≥—Ä–∞—Ü–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞ - –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –±–µ–∑ –≤—Ä–µ–¥–∞

## üö® –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ —á—Ç–æ-—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞–ª–æ —Ä–∞–±–æ—Ç–∞—Ç—å:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –æ—à–∏–±–æ–∫ –≤ Supabase Dashboard
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã (—Å–º. –ø—Ä–æ–≤–µ—Ä–∫—É –≤—ã—à–µ)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `is_admin()` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

---

**–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è "Auth RLS Initialization Plan" –¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å!** ‚úÖ


