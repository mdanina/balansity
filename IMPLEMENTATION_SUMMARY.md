# ‚úÖ –ò—Ç–æ–≥–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π

## üéØ –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. ‚úÖ Retry Limit —Å Exponential Backoff –≤ Queue Worker

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–¥–∞—á–∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏—Å—å –≤ –æ—á–µ—Ä–µ–¥—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º —Ü–∏–∫–ª–∞–º.

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `queue-worker/src/utils/retry.ts` —Å –ª–æ–≥–∏–∫–æ–π retry
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π `read_ct` –∏–∑ pgmq –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–ø—ã—Ç–æ–∫
- ‚úÖ Exponential backoff: 1s, 2s, 4s, 8s, 16s... (–º–∞–∫—Å–∏–º—É–º 60s)
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ª–∏–º–∏—Ç—ã —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
  - `MAX_EMAIL_RETRY_ATTEMPTS=5` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `MAX_PAYMENT_RETRY_ATTEMPTS=5` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `MAX_REPORT_RETRY_ATTEMPTS=3` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã: `email.ts`, `payments.ts`, `reports.ts`

**–§–∞–π–ª—ã:**
- `queue-worker/src/utils/retry.ts` - —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è retry –ª–æ–≥–∏–∫–∏
- `queue-worker/src/processors/email.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω —Å retry
- `queue-worker/src/processors/payments.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω —Å retry
- `queue-worker/src/processors/reports.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω —Å retry
- `RETRY_LOGIC_DOCUMENTATION.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

### 2. ‚úÖ Sentry –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ production –æ—à–∏–±–æ–∫

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∏ –≤ production –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–ª–∏—Å—å, —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ –∫–æ–Ω—Å–æ–ª—å.

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `@sentry/react` –≤ `package.json`
- ‚úÖ –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `src/lib/sentry.ts` –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Sentry
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ `src/main.tsx`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `ErrorBoundary.tsx` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—à–∏–±–æ–∫ React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `logger.ts` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Sentry —á–µ—Ä–µ–∑ `AuthContext`
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ—à–∏–±–æ–∫ (–±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
- ‚úÖ Performance Monitoring (10% —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ production)
- ‚úÖ Session Replay (10% —Å–µ—Å—Å–∏–π, 100% —Å–µ—Å—Å–∏–π —Å –æ—à–∏–±–∫–∞–º–∏)

**–§–∞–π–ª—ã:**
- `src/lib/sentry.ts` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Sentry
- `src/main.tsx` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Sentry
- `src/components/ErrorBoundary.tsx` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—à–∏–±–æ–∫ React
- `src/lib/logger.ts` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- `src/contexts/AuthContext.tsx` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Sentry
- `SENTRY_SETUP.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- `env.production.example` - –ø—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```env
VITE_SENTRY_DSN=https://your-dsn@sentry.io/project-id
VITE_SENTRY_ENABLE_IN_DEV=false  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
```

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### –§—Ä–æ–Ω—Ç–µ–Ω–¥:
```bash
npm install @sentry/react
```

### Queue Worker:
–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

---

## üöÄ –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### 1. Retry Logic (—É–∂–µ –≥–æ—Ç–æ–≤–æ)

–ù–∏—á–µ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è - –ª–æ–≥–∏–∫–∞ —É–∂–µ –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã.

–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏–º–∏—Ç—ã –≤ `.env` queue worker:
```env
MAX_EMAIL_RETRY_ATTEMPTS=5
MAX_PAYMENT_RETRY_ATTEMPTS=5
MAX_REPORT_RETRY_ATTEMPTS=3
```

### 2. Sentry

1. **–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ Sentry:**
   - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ [sentry.io](https://sentry.io)
   - –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç (Platform: React)
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ DSN

2. **–î–æ–±–∞–≤—å—Ç–µ DSN –≤ `.env.production`:**
   ```env
   VITE_SENTRY_DSN=https://your-dsn@sentry.io/project-id
   ```

3. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
   ```bash
   npm install
   ```

4. **–ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç:**
   ```bash
   npm run build
   ```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### Retry Logic:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ queue worker:
   ```bash
   pm2 logs balansity-queue-worker
   ```

2. –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤–∏–¥–∞:
   ```
   [INFO] Processing email task (attempt 1/5): user@example.com
   [WARN] Failed to send email, will retry (attempt 2/5)
   [ERROR] Email failed after 5 attempts. Task archived.
   ```

### Sentry:

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –æ—à–∏–±–∫—É (–≤—Ä–µ–º–µ–Ω–Ω–æ):
   ```typescript
   // –í –ª—é–±–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
   useEffect(() => {
     if (import.meta.env.VITE_SENTRY_DSN) {
       throw new Error('Test Sentry error');
     }
   }, []);
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Sentry Dashboard - –æ—à–∏–±–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Sentry (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–µ–Ω –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –æ—à–∏–±–æ–∫)

---

## üìä –£–ª—É—á—à–µ–Ω–∏—è

### –î–æ:
- ‚ùå –ó–∞–¥–∞—á–∏ –º–æ–≥–ª–∏ –∑–∞—Ü–∏–∫–ª–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚ùå –ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ –≤ production
- ‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚ùå –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ü–æ—Å–ª–µ:
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ)
- ‚úÖ Exponential backoff (–æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ Sentry
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ Performance Monitoring
- ‚úÖ Session Replay –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### Retry Logic:

–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ `queue-worker/src/utils/retry.ts`:
- `baseDelayMs` - –±–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1000ms)
- `maxDelayMs` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60000ms)
- `backoffMultiplier` - –º–Ω–æ–∂–∏—Ç–µ–ª—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2)

### Sentry:

–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ `src/lib/sentry.ts`:
- `tracesSampleRate` - –ø—Ä–æ—Ü–µ–Ω—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è Performance Monitoring
- `replaysSessionSampleRate` - –ø—Ä–æ—Ü–µ–Ω—Ç —Å–µ—Å—Å–∏–π –¥–ª—è Session Replay
- `beforeSend` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ—à–∏–±–æ–∫ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

---

## üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `RETRY_LOGIC_DOCUMENTATION.md` - –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ retry –ª–æ–≥–∏–∫–µ
- `SENTRY_SETUP.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Sentry
- `queue-worker/README.md` - –æ–±–Ω–æ–≤–ª–µ–Ω —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ retry
- `queue-worker/env.production.example` - –ø—Ä–∏–º–µ—Ä —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ retry

---

**–û–±–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** ‚úÖ



